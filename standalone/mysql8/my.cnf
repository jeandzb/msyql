[mysqld]
# --- 基础配置 (必须与旧实例保持一致) ---
pid-file = /var/lib/mysql/mysqld.pid
user                           = mysql
port                           = 3306
character-set-server           = utf8mb4
collation-server               = utf8mb4_general_ci
lower_case_table_names         = 1
skip-name-resolve
authentication_policy          = mysql_native_password
default_authentication_plugin  = caching_sha2_password
# 此参数在不同的版本会有差异
sql_mode                       = STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO

# --- 内存分配调优 (针对 6GB 内存 & 1000 连接) ---
# 稍微下调 Buffer Pool 以应对 1000 连接可能带来的私有内存开销 (每个连接约占用 1-2MB 基础内存)
innodb_buffer_pool_size        = 1536M
innodb_buffer_pool_instances   = 2
# 线程堆栈大小，256K 足够大多数业务使用
thread_stack                   = 256K
# 关闭性能模式，直接节省数百兆内存
performance_schema = OFF
innodb_adaptive_hash_index = OFF
table_open_cache = 1500
table_definition_cache = 1000

# --- 连接管理 (针对业务连接池失效防御) ---
max_connections                = 1000
# 大幅增加线程缓存，避免频繁创建/销毁线程导致的 CPU 剧烈波动
thread_cache_size              = 16
# 加快僵尸连接回收：5分钟无操作强制断开 (之前是600秒)
wait_timeout                   = 1800
interactive_timeout            = 1800
# 限制排序、读取等私有缓冲区大小，防止 1000 连接同时并发时 OOM
sort_buffer_size               = 256K
join_buffer_size               = 256K
read_buffer_size               = 256K
read_rnd_buffer_size           = 256K

# --- I/O 优化 (针对 SSD) ---
innodb_flush_method            = O_DIRECT
innodb_io_capacity             = 2000
innodb_io_capacity_max         = 4000
innodb_flush_neighbors         = 0

# --- 日志持久化 (8.0.28 兼容性写法) ---
innodb_log_file_size           = 512M
innodb_log_files_in_group      = 2
innodb_log_buffer_size         = 32M
# 设为 2 可兼顾性能与安全，掉电仅丢失 1s 数据，极大缓解 I/O 压力
innodb_flush_log_at_trx_commit = 2

# --- 二进制日志与慢查询 ---
# 单节点时，关闭binlog
skip-log-bin
# 开启binlog时打开此配置
# binlog_expire_logs_seconds     = 604800
slow_query_log                 = 1
long_query_time                = 2
slow_query_log_file            = /var/lib/mysql/slow.log